name: Deploy

on:
  push:
    branches:
      - master

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Build Docker image
      run: docker build -t vorishka-bot:latest .

    - name: Save Docker image
      run: docker save vorishka-bot:latest > vorishka-bot.tar

    - name: Deploy to server
      env:
        PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        TARGET_PATH: ${{ secrets.REMOTE_PATH }}
      run: |
        echo "$PRIVATE_KEY" > private_key
        chmod 600 private_key
        scp -o StrictHostKeyChecking=no -i private_key docker-compose.production.yml vorishka-bot.tar \
          ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_SERVER }}:$TARGET_PATH
        ssh -T -o StrictHostKeyChecking=no -i private_key ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_SERVER }} <<EOF
          cd $TARGET_PATH
          docker load < vorishka-bot.tar
          docker-compose down
          docker-compose -f docker-compose.production.yml up -d
          rm -f vorishka-bot.tar
          docker image prune --force
        EOF
        rm -f private_key
